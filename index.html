<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard</title>
  <!-- Gridstack (drag & resize layout) -->
  <link href="https://cdn.jsdelivr.net/npm/gridstack@10.3.1/dist/gridstack.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/gridstack@10.3.1/dist/gridstack-h5.js"></script>
  <style>
    :root{
      --bg:#0b0f14; /* deep slate */
      --bg-soft:#101720;
      --panel:#131a24;
      --panel-2:#0f1520;
      --text:#e6eef7;
      --muted:#93a4b5;
      --accent:#4cc2ff;
      --accent-2:#7c4dff;
      --danger:#ff5d5d;
      --ok:#3bd88f;
      --grid-gutter:10px;
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --zoom:1; /* adjustable */
      --cell-h:90px; /* grid cell height (scales with zoom) */
      --header-h:72px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }
    .app{
      display:flex; flex-direction:column; height:100%;
    }

    /* Top title bar shows live Date/Time (as "title" instead of heading) */
    header{
      position:sticky; top:0; z-index:50; background:linear-gradient(180deg, rgba(19,26,36,.9), rgba(19,26,36,.6)); backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .bar{
      display:flex; align-items:center; gap:12px; padding:12px 16px; min-height:var(--header-h);
    }
    .clockTitle{flex:1; font-weight:700; letter-spacing:0.2px; display:flex; align-items:baseline; gap:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .clockTitle .time{font-size:28px}
    .clockTitle .date{font-size:15px; color:var(--muted)}

    .modeBadge{font-size:12px; color:#fff; background:linear-gradient(135deg, var(--accent), var(--accent-2)); padding:6px 10px; border-radius:999px; box-shadow:var(--shadow)}

    .toolbar{display:flex; align-items:center; gap:10px}
    .toolbar button, .toolbar .select{
      background:var(--panel); color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px;
      cursor:pointer; box-shadow:var(--shadow);
    }
    .toolbar button:hover{border-color:rgba(255,255,255,.18)}
    .toolbar .select{display:flex; align-items:center; gap:8px}
    .toolbar input[type="range"]{width:150px}

    /* Layout */
    .wrap{flex:1; min-height:0; overflow:auto;}
    .dashboard-zoom{
      transform:scale(var(--zoom)); transform-origin:0 0; width:calc(100%/var(--zoom)); padding:16px; transition:transform .15s ease;
    }

    /* Gridstack overrides */
    .grid-stack{ --gs-gutter: var(--grid-gutter); }
    .grid-stack-item-content{
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow);
      display:flex; flex-direction:column; min-height:100%; overflow:hidden;
    }

    /* Widget chrome */
    .w-header{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); }
    .w-title{ font-weight:600; flex:1 }
    .w-actions{ display:flex; gap:6px }
    .iconBtn{
      background:transparent; border:1px solid rgba(255,255,255,.08); color:var(--text); border-radius:10px; padding:6px 8px; cursor:pointer;
    }
    .iconBtn:hover{ border-color:rgba(255,255,255,.18) }
    .w-body{ flex:1; padding:12px; overflow:auto }
    .cfg{ display:none; gap:12px; padding:10px 12px; border-top:1px dashed rgba(255,255,255,.08); background:rgba(255,255,255,.03) }
    .cfg label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px }
    .cfg input, .cfg select, .cfg textarea{
      width:100%; background:#0d141d; color:var(--text); border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:8px 10px;
    }

    /* Live mode hides edit UI */
    .live .icon-edit, .live .icon-add, .live .icon-del, .live .cfg, .live .modeBadge, .live .toolbar .editOnly{ display:none !important }
    .live .grid-stack{ pointer-events:auto }
    .live .grid-stack .ui-resizable-handle, .live .grid-stack .ui-draggable-handle{ display:none }

    /* Empty state */
    .empty-hint{ opacity:.7; text-align:center; padding:30px; border:1px dashed rgba(255,255,255,.1); border-radius:12px }

    /* Small helpers */
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .row-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px }
    @media (max-width:900px){ .row-3{ grid-template-columns:1fr } .row{ grid-template-columns:1fr } }

    /* Link style */
    a{ color:#b3d9ff }
  :root{
      --bg:#0b0f14; /* deep slate */
      --bg-soft:#101720;
      --panel:#131a24;
      --panel-2:#0f1520;
      --text:#e6eef7;
      --muted:#93a4b5;
      --accent:#4cc2ff;
      --accent-2:#7c4dff;
      --danger:#ff5d5d;
      --ok:#3bd88f;
      --grid-gutter:10px;
      --radius:16px;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --zoom:1; /* adjustable */
      --cell-h:90px; /* grid cell height (scales with zoom) */
      --header-h:72px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text); font:14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }
    .app{
      display:flex; flex-direction:column; height:100%;
    }

    /* Top title bar shows live Date/Time (as "title" instead of heading) */
    header{
      position:sticky; top:0; z-index:9999; background:linear-gradient(180deg, rgba(19,26,36,.9), rgba(19,26,36,.6)); backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .bar{
      display:flex; align-items:center; gap:12px; padding:12px 16px; min-height:var(--header-h);
    }
    .clockTitle{flex:1; font-weight:700; letter-spacing:0.2px; display:flex; align-items:baseline; gap:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .clockTitle .time{font-size:28px}
    .clockTitle .date{font-size:15px; color:var(--muted)}

    .modeBadge{font-size:12px; color:#fff; background:linear-gradient(135deg, var(--accent), var(--accent-2)); padding:6px 10px; border-radius:999px; box-shadow:var(--shadow)}

    .toolbar{display:flex; align-items:center; gap:10px}
    .toolbar button, .toolbar .select{
      background:var(--panel); color:var(--text); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px;
      cursor:pointer; box-shadow:var(--shadow);
    }
    .toolbar button:hover{border-color:rgba(255,255,255,.18)}
    .toolbar .select{display:flex; align-items:center; gap:8px}
    .toolbar input[type="range"]{width:150px}

    /* Layout */
    .wrap{flex:1; min-height:0; overflow:auto;}
    .dashboard-zoom{
      transform:scale(var(--zoom)); transform-origin:0 0; width:calc(100%/var(--zoom)); padding:16px; transition:transform .15s ease;
    }

    /* Gridstack overrides */
    .grid-stack{ --gs-gutter: var(--grid-gutter); min-height: calc(100vh - var(--header-h) - 48px);} 
    .grid-stack-item-content{
      background:linear-gradient(180deg, var(--panel), var(--panel-2));
      border:1px solid rgba(255,255,255,.06); border-radius:var(--radius); box-shadow:var(--shadow);
      display:flex; flex-direction:column; min-height:100%; overflow:hidden;
    }

    /* Widget chrome */
    .w-header{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); }
    .w-title{ font-weight:600; flex:1 }
    .w-actions{ display:flex; gap:6px }
    .iconBtn{
      background:transparent; border:1px solid rgba(255,255,255,.08); color:var(--text); border-radius:10px; padding:6px 8px; cursor:pointer;
    }
    .iconBtn:hover{ border-color:rgba(255,255,255,.18) }
    .w-body{ flex:1; padding:12px; overflow:auto }
    .cfg{ display:none; gap:12px; padding:10px 12px; border-top:1px dashed rgba(255,255,255,.08); background:rgba(255,255,255,.03) }
    .cfg label{ font-size:12px; color:var(--muted); display:block; margin-bottom:4px }
    .cfg input, .cfg select, .cfg textarea{
      width:100%; background:#0d141d; color:var(--text); border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:8px 10px;
    }

    /* Live mode hides edit UI */
    .live .icon-edit, .live .icon-add, .live .icon-del, .live .cfg, .live .modeBadge, .live .toolbar .editOnly{ display:none !important }
    .live .grid-stack{ pointer-events:auto }
    .live .grid-stack .ui-resizable-handle, .live .grid-stack .ui-draggable-handle{ display:none }

    /* Empty state */
    .empty-hint{ opacity:.7; text-align:center; padding:30px; border:1px dashed rgba(255,255,255,.1); border-radius:12px }

    /* Small helpers */
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    .row-3{ display:grid; grid-template-columns:repeat(3,1fr); gap:12px }
    @media (max-width:900px){ .row-3{ grid-template-columns:1fr } .row{ grid-template-columns:1fr } }

    /* Link style */
    a{ color:#b3d9ff }
  </style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="bar">
      <div class="clockTitle">
        <span class="time" id="titleTime">--:--</span>
        <span class="date" id="titleDate">-- -- ----</span>
      </div>
      <span class="modeBadge" id="modeBadge">Bearbeitungsmodus</span>
      <div class="toolbar">
        <button id="toggleMode">Live-Modus</button>
        <div class="select editOnly">
          <label for="tzSelect" style="font-size:12px;color:var(--muted)">Zeitzone</label>
          <select id="tzSelect"></select>
        </div>
        <div class="select editOnly">
          <label for="localeSelect" style="font-size:12px;color:var(--muted)">Region/Format</label>
          <select id="localeSelect"></select>
        </div>
        <div class="select editOnly" title="Skalierung der gesamten Ansicht">
          <label for="zoomRange" style="font-size:12px;color:var(--muted)">Skalierung</label>
          <input type="range" min="0.6" max="1.6" step="0.02" id="zoomRange" />
        </div>
        <button class="editOnly" id="addWidget">+ Widget</button>
        <button class="editOnly" id="saveLayout">Speichern</button>
        <button class="editOnly" id="resetLayout" style="color:#fff;background:linear-gradient(135deg, var(--danger), #ff9a9a)">Zur√ºcksetzen</button>
      </div>
    </div>
  </header>

  <div class="wrap">
    <div class="dashboard-zoom">
      <div class="grid-stack" id="grid"></div>
      <div id="emptyState" class="empty-hint" style="display:none">Keine Widgets. Klicke im Bearbeitungsmodus auf <em>+ Widget</em>.</div>
    </div>
  </div>
</div>

<!-- Templates -->
<template id="tpl-widget">
  <div class="grid-stack-item" gs-w="4" gs-h="3">
    <div class="grid-stack-item-content widget" data-type="">
      <div class="w-header">
        <div class="w-title">Widget</div>
        <div class="w-actions">
          <button class="iconBtn icon-edit" title="Konfiguration umschalten">‚öôÔ∏è</button>
          <button class="iconBtn icon-del" title="Entfernen">üóëÔ∏è</button>
        </div>
      </div>
      <div class="w-body"></div>
      <div class="cfg"></div>
    </div>
  </div>
</template>

<template id="tpl-widget-picker">
  <div class="grid-stack-item" gs-w="4" gs-h="4">
    <div class="grid-stack-item-content widget" data-type="picker">
      <div class="w-header"><div class="w-title">Widget hinzuf√ºgen</div><div class="w-actions"><button class="iconBtn icon-del">üóëÔ∏è</button></div></div>
      <div class="w-body">
        <div class="row-3">
          <button class="iconBtn" data-add="clock">üïí Uhr & Datum</button>
          <button class="iconBtn" data-add="weather">‚õÖ Wetter</button>
          <button class="iconBtn" data-add="gcal">üìÖ Google Kalender</button>
          <button class="iconBtn" data-add="crypto">‚Çø Krypto Kurse</button>
          <button class="iconBtn" data-add="stocks">üìà Aktienkurse</button>
          <button class="iconBtn" data-add="custom">üß© Custom Webpart</button>
        </div>
        <p style="color:var(--muted);margin-top:12px">Tipp: Im Live‚ÄëModus sind Konfigurationselemente ausgeblendet und Drag/Resize deaktiviert.</p>
      </div>
    </div>
  </div>
</template>

<script>
// Global error catcher to avoid silent failures and show a helpful message
window.addEventListener('error', (e)=>{
  try{
    const msg = (e && e.message) ? e.message : 'Unbekannter Scriptfehler';
    let box = document.getElementById('bootError');
    if(!box){
      box = document.createElement('div');
      box.id = 'bootError';
      box.style.cssText='position:fixed;left:16px;right:16px;top:16px;z-index:10000;background:#2a0f12;color:#ffd2d2;border:1px solid #ff5d5d;border-radius:12px;padding:12px 14px;box-shadow:0 10px 30px rgba(0,0,0,.5);font:13px system-ui';
      document.body.appendChild(box);
    }
    box.innerHTML = '<b>Dashboard-Skriptfehler:</b> '+ msg + '<br><small>Bitte Screenshot senden ‚Äì ich h√§rte es dann sofort aus.</small>';
  }catch(_){/* ignore */}
});
// Robust UUID helper for older environments
const __uuid = (typeof crypto !== 'undefined' && crypto.randomUUID) ? () => crypto.randomUUID() : () => 'id-' + (Math.random().toString(36).slice(2)) + '-' + Date.now();
(function(){
  // Ensure code runs after DOM is ready even if script is moved
  if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initDash); } else { initDash(); }
  function initDash(){

  const app = document.getElementById('app');
  const gridEl = document.getElementById('grid');
  const emptyState = document.getElementById('emptyState');

  // --- Layout engine ---
  let grid;
  try {
    if (window.GridStack) {
      grid = GridStack.init({
        float: true,
        margin: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--grid-gutter')),
        cellHeight: parseInt(getComputedStyle(document.documentElement).getPropertyValue('--cell-h')),
        resizable: { handles: 'all' },
        acceptWidgets: true,
        disableDrag: false,
        disableResize: false,
      });
    } else { throw new Error('GridStack not loaded'); }
  } catch(e) {
    console.warn('GridStack unavailable, using basic fallback layout.', e);
    grid = {
      engine: { nodes: [] },
      addWidget: (item)=>{ gridEl.appendChild(item); grid.engine.nodes.push({el:item, x:0, y: grid.engine.nodes.length, w: parseInt(item.getAttribute('gs-w'))||4, h: parseInt(item.getAttribute('gs-h'))||3}); },
      removeWidget: (item)=>{ item.remove(); grid.engine.nodes = grid.engine.nodes.filter(n=>n.el!==item); },
      on: ()=>{},
      setStatic: ()=>{},
      removeAll: ()=>{ gridEl.innerHTML=''; grid.engine.nodes = []; },
      get: ()=>grid
    };
  }

  function updateEmpty(){ const has = (grid && grid.engine && grid.engine.nodes && grid.engine.nodes.length) || gridEl.children.length; emptyState.style.display = has ? 'none' : 'block'; }
  grid.on('added removed change', updateEmpty);

  // --- Mode handling ---
  const toggleBtn = document.getElementById('toggleMode');
  const modeBadge = document.getElementById('modeBadge');
  let live = false;
  function applyMode(){
    app.classList.toggle('live', live);
    if(live){
      toggleBtn.textContent = 'Bearbeiten';
      modeBadge.style.display = 'none';
      grid.setStatic(true);
    }else{
      toggleBtn.textContent = 'Live‚ÄëModus';
      modeBadge.style.display = '';
      modeBadge.textContent = 'Bearbeitungsmodus';
      grid.setStatic(false);
    }
  }
  toggleBtn.addEventListener('click', ()=>{ live = !live; savePrefs(); applyMode(); });

  // --- Global prefs (timezone, locale, zoom) ---
  const tzSelect = document.getElementById('tzSelect');
  const localeSelect = document.getElementById('localeSelect');
  const zoomRange = document.getElementById('zoomRange');
  const prefs = JSON.parse(localStorage.getItem('dash:prefs')||'{}');

  function populateTimezones(){
    let zones = [];
    try{
      if (Intl.supportedValuesOf) zones = Intl.supportedValuesOf('timeZone');
    }catch(e){}
    if(!zones || !zones.length){
      zones = ['Europe/Zurich','Europe/Berlin','Europe/Paris','Europe/Vienna','UTC','America/New_York','America/Los_Angeles','Asia/Dubai','Asia/Tokyo'];
    }
    const cur = (Intl.DateTimeFormat().resolvedOptions().timeZone)||'Europe/Zurich';
    tzSelect.innerHTML = zones.map(z=>`<option ${z===cur?'selected':''}>${z}</option>`).join('');
  }</option>`).join('');
  }
  function populateLocales(){
    const guess = navigator.language || 'de-CH';
    const opts = ['de-CH','de-DE','fr-CH','it-CH','en-GB','en-US','fr-FR'];
    if(!opts.includes(guess)) opts.unshift(guess);
    localeSelect.innerHTML = opts.map(l=>`<option ${l===guess?'selected':''}>${l}</option>`).join('');
  }>${l}</option>`).join('');
  }
  function applyZoom(){
    document.documentElement.style.setProperty('--zoom', prefs.zoom || 1);
    zoomRange.value = prefs.zoom || 1;
  }
  function savePrefs(){
    localStorage.setItem('dash:prefs', JSON.stringify({
      live, tz: tzSelect.value, locale: localeSelect.value, zoom: parseFloat(zoomRange.value||1)
    }));
  }
  populateTimezones(); populateLocales();
  tzSelect.value = prefs.tz || Intl.DateTimeFormat().resolvedOptions().timeZone || 'Europe/Zurich';
  localeSelect.value = prefs.locale || (navigator.language||'de-CH');
  zoomRange.value = prefs.zoom || 1;
  zoomRange.addEventListener('input', ()=>{ document.documentElement.style.setProperty('--zoom', zoomRange.value); savePrefs(); });
  tzSelect.addEventListener('change', savePrefs);
  localeSelect.addEventListener('change', savePrefs);

  // --- Title clock ---
  const titleTime = document.getElementById('titleTime');
  const titleDate = document.getElementById('titleDate');
  function tick(){
    const now = new Date();
    const tz = tzSelect.value;
    const locale = localeSelect.value;
    const fmtTime = new Intl.DateTimeFormat(locale, {hour:'2-digit', minute:'2-digit', second:'2-digit', timeZone: tz});
    const fmtDate = new Intl.DateTimeFormat(locale, {weekday:'long', day:'2-digit', month:'long', year:'numeric', timeZone: tz});
    titleTime.textContent = fmtTime.format(now);
    titleDate.textContent = fmtDate.format(now);
  }
  setInterval(tick, 1000); tick();

  // --- Widget Factory ---
  const types = {
    clock: {
      name:'Uhr & Datum', size:[3,2],
      render(w){
        w.title('Uhr & Datum');
        const body = w.body;
        body.innerHTML = `<div style="display:flex;flex-direction:column;gap:6px">
          <div style="font-size:42px;font-weight:700" data-el="t">--:--</div>
          <div style="font-size:16px;color:var(--muted)" data-el="d">‚Äî</div>
        </div>`;
        const tEl = body.querySelector('[data-el="t"]');
        const dEl = body.querySelector('[data-el="d"]');
        function update(){
          const now = new Date();
          const tz = tzSelect.value; const loc = localeSelect.value;
          tEl.textContent = new Intl.DateTimeFormat(loc,{hour:'2-digit',minute:'2-digit',second:'2-digit', timeZone:tz}).format(now);
          dEl.textContent = new Intl.DateTimeFormat(loc,{weekday:'long', day:'2-digit', month:'long', year:'numeric', timeZone:tz}).format(now);
        }
        w.interval(update, 1000);
        // config (none)
      }
    },
    weather: {
      name:'Wetter', size:[4,3],
      render(w){
        w.title('Wetter');
        const cfg = w.ensureConfig({ api:"", city:"Bern", units:"metric" });
        w.cfgHTML(`<div class="row">
          <div><label>OpenWeatherMap API Key</label><input data-k="api" value="${cfg.api}"></div>
          <div><label>Ort (z.B. Bern,CH)</label><input data-k="city" value="${cfg.city}"></div>
          <div><label>Einheiten</label><select data-k="units"><option value="metric" ${cfg.units==='metric'?'selected':''}>Metric (¬∞C)</option><option value="imperial" ${cfg.units==='imperial'?'selected':''}>Imperial (¬∞F)</option></select></div>
        </div>`);
        const body = w.body; body.innerHTML = `<div id="w-main" style="display:flex;align-items:center;gap:16px"><div style="font-size:40px" id="w-temp">--¬∞</div><div><div id="w-city" style="font-weight:600">‚Äî</div><div style="color:var(--muted)" id="w-desc">‚Äî</div></div></div>`;
        async function load(){
          if(!cfg.api){ body.querySelector('#w-desc').textContent = 'API Key n√∂tig (OpenWeatherMap)'; return; }
          try{
            const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(cfg.city)}&appid=${cfg.api}&units=${cfg.units}`;
            const res = await fetch(url); const j = await res.json();
            body.querySelector('#w-city').textContent = `${j.name}`;
            body.querySelector('#w-temp').textContent = Math.round(j.main.temp) + '¬∞';
            body.querySelector('#w-desc').textContent = j.weather?.[0]?.description || '';
          }catch(e){ body.querySelector('#w-desc').textContent = 'Fehler beim Laden'; }
        }
        w.onCfg(load); load();
      }
    },
    gcal: {
      name:'Google Kalender', size:[6,5],
      render(w){
        w.title('Google Kalender');
        const cfg = w.ensureConfig({ mode:'iframe', iframeSrc:'', apiKey:'', calendarId:'', maxItems:10 });
        w.cfgHTML(`<div class="row">
          <div><label>Modus</label><select data-k="mode"><option value="iframe" ${cfg.mode==='iframe'?'selected':''}>√ñffentliche Kalender-URL (iframe)</option><option value="api" ${cfg.mode==='api'?'selected':''}>Google API (Key + Kalender-ID)</option></select></div>
          <div><label>iframe src (√∂ffentlich geteilter Kalender)</label><input data-k="iframeSrc" placeholder="https://calendar.google.com/calendar/embed?..." value="${cfg.iframeSrc}"></div>
          <div><label>API Key</label><input data-k="apiKey" value="${cfg.apiKey}"></div>
          <div><label>Kalender-ID</label><input data-k="calendarId" value="${cfg.calendarId}" placeholder="abc123@group.calendar.google.com"></div>
          <div><label>Max. Eintr√§ge</label><input type="number" min="1" max="50" data-k="maxItems" value="${cfg.maxItems}"></div>
        </div>`);
        const body = w.body;
        function renderIframe(){
          if(!cfg.iframeSrc){ body.innerHTML = '<p style="color:var(--muted)">√ñffentliche Kalender‚ÄëURL einf√ºgen.</p>'; return;}
          body.innerHTML = `<iframe style="width:100%;height:100%;border:0;border-radius:10px;background:#0b0f14" src="${cfg.iframeSrc}"></iframe>`;
        }
        async function renderApi(){
          if(!cfg.apiKey||!cfg.calendarId){ body.innerHTML = '<p style="color:var(--muted)">API Key & Kalender‚ÄëID angeben.</p>'; return; }
          const timeMin = new Date().toISOString();
          const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(cfg.calendarId)}/events?singleEvents=true&orderBy=startTime&timeMin=${encodeURIComponent(timeMin)}&maxResults=${cfg.maxItems}&key=${cfg.apiKey}`;
          body.innerHTML = '<p style="color:var(--muted)">Lade‚Ä¶</p>';
          try{
            const r = await fetch(url); const j = await r.json();
            if(!j.items){ throw 0 }
            body.innerHTML = j.items.map(ev=>{
              const start = ev.start.dateTime || ev.start.date;
              const dt = new Date(start);
              const when = new Intl.DateTimeFormat(localeSelect.value,{weekday:'short', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit', timeZone: tzSelect.value}).format(dt);
              return `<div style="padding:10px 12px;border:1px solid rgba(255,255,255,.06);border-radius:10px;margin-bottom:8px">
                <div style="font-weight:600">${ev.summary||'(ohne Titel)'}</div>
                <div style="color:var(--muted)">${when}</div>
              </div>`
            }).join('');
          }catch(e){ body.innerHTML = '<p style="color:var(--muted)">Fehler beim Laden.</p>'; }
        }
        function renderMode(){ cfg.mode==='iframe'?renderIframe():renderApi(); }
        w.onCfg(renderMode); renderMode();
      }
    },
    crypto: {
      name:'Krypto Kurse', size:[5,3],
      render(w){
        w.title('Krypto Kurse');
        const cfg = w.ensureConfig({ coins:'bitcoin,ethereum,solana', currency:'chf' });
        w.cfgHTML(`<div class="row">
          <div><label>Coins (Coingecko IDs, Komma‚Äëgetrennt)</label><input data-k="coins" value="${cfg.coins}"></div>
          <div><label>W√§hrung</label><input data-k="currency" value="${cfg.currency}"></div>
        </div>`);
        const body = w.body;
        async function load(){
          const ids = cfg.coins.replace(/\s+/g,''); if(!ids){ body.innerHTML = 'Konfigurieren'; return; }
          const url = `https://api.coingecko.com/api/v3/simple/price?ids=${encodeURIComponent(ids)}&vs_currencies=${encodeURIComponent(cfg.currency)}&include_24hr_change=true`;
          try{
            const r = await fetch(url); const j = await r.json();
            body.innerHTML = Object.entries(j).map(([id,data])=>{
              const price = data[cfg.currency]; const chg = data[`${cfg.currency}_24h_change`];
              const sign = chg>=0?'+':''; const color = chg>=0? 'var(--ok)':'var(--danger)';
              return `<div style="display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px dotted rgba(255,255,255,.08)">
                <div style="text-transform:capitalize">${id}</div>
                <div style="font-weight:600">${new Intl.NumberFormat(localeSelect.value,{style:'currency', currency: cfg.currency.toUpperCase()}).format(price)}</div>
                <div style="color:${color}">${sign}${chg.toFixed(2)}%</div>
              </div>`
            }).join('');
          }catch(e){ body.innerHTML = '<p style="color:var(--muted)">Fehler beim Laden.</p>'; }
        }
        w.interval(load, 60_000); w.onCfg(load); load();
      }
    },
    stocks: {
      name:'Aktienkurse', size:[5,3],
      render(w){
        w.title('Aktienkurse');
        const cfg = w.ensureConfig({ symbols:'AAPL,MSFT,GOOGL,NVDA', apiKey:'' });
        w.cfgHTML(`<div class="row">
          <div><label>Ticker Symbole (Komma‚Äëgetrennt)</label><input data-k="symbols" value="${cfg.symbols}"></div>
          <div><label>Alpha Vantage API Key</label><input data-k="apiKey" value="${cfg.apiKey}"></div>
        </div>`);
        const body = w.body;
        async function load(){
          if(!cfg.apiKey){ body.innerHTML = '<p style="color:var(--muted)">API Key ben√∂tigt (Alpha Vantage)</p>'; return; }
          const syms = cfg.symbols.split(',').map(s=>s.trim()).filter(Boolean).slice(0,10);
          body.innerHTML = '';
          for(const s of syms){
            try{
              const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${encodeURIComponent(s)}&apikey=${cfg.apiKey}`;
              const r = await fetch(url); const j = await r.json();
              const q = j['Global Quote']||{}; const price = parseFloat(q['05. price']||'NaN'); const chg = parseFloat(q['10. change percent']?.replace('%','')||'NaN');
              const color = chg>=0? 'var(--ok)':'var(--danger)'; const sign = isNaN(chg)?'':(chg>=0?'+':'');
              const row = document.createElement('div');
              row.style.cssText='display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px dotted rgba(255,255,255,.08)';
              row.innerHTML = `<div>${s}</div><div style="font-weight:600">${isNaN(price)?'‚Äî':price.toFixed(2)}</div><div style="color:${color}">${isNaN(chg)?'‚Äî':sign+chg.toFixed(2)+'%'}</div>`;
              body.appendChild(row);
            }catch(e){ body.innerHTML = '<p style="color:var(--muted)">Fehler beim Laden.</p>'; break; }
          }
        }
        w.interval(load, 60_000); w.onCfg(load); load();
      }
    },
    custom: {
      name:'Custom Webpart', size:[6,4],
      render(w){
        w.title('Custom Webpart');
        const cfg = w.ensureConfig({ mode:'iframe', html:'<h2 style="margin:0">Eigene Inhalte</h2><p style="color:var(--muted)">Bearbeitungsmodus √∂ffnen, um dies anzupassen.</p>', iframeSrc:'', allow:"accelerometer; clipboard-write; encrypted-media; picture-in-picture;" });
        w.cfgHTML(`<div class="row">
          <div><label>Modus</label><select data-k="mode"><option value="iframe" ${cfg.mode==='iframe'?'selected':''}>iframe</option><option value="html" ${cfg.mode==='html'?'selected':''}>Inline HTML</option></select></div>
          <div><label>iframe src</label><input data-k="iframeSrc" value="${cfg.iframeSrc}" placeholder="https://‚Ä¶"></div>
          <div><label>iframe allow</label><input data-k="allow" value="${cfg.allow}"></div>
          <div style="grid-column:1/-1"><label>Inline HTML</label><textarea rows="6" data-k="html">${cfg.html.replace(/</g,'&lt;')}</textarea></div>
        </div>`);
        const body = w.body;
        function render(){
          if(cfg.mode==='iframe'){
            if(!cfg.iframeSrc){ body.innerHTML = '<p style="color:var(--muted)">iframe‚ÄëQuelle angeben.</p>'; return; }
            body.innerHTML = `<iframe style="width:100%;height:100%;border:0;border-radius:10px;background:#0b0f14" src="${cfg.iframeSrc}" allow="${cfg.allow}"></iframe>`;
          }else{
            body.innerHTML = cfg.html;
          }
        }
        w.onCfg(render); render();
      }
    }
  };

  // --- Widget helpers ---
  function Widget(el){
    this.el = el; this.body = el.querySelector('.w-body'); this.cfgEl = el.querySelector('.cfg'); this.header = el.querySelector('.w-header');
    this.type = el.dataset.type;
  }
  Widget.prototype.title = function(t){ this.header.querySelector('.w-title').textContent = t; }
  Widget.prototype.cfgHTML = function(html){ this.cfgEl.innerHTML = html; this.cfgEl.querySelectorAll('[data-k]').forEach(inp=>{
    inp.addEventListener('input', ()=>{ const k=inp.dataset.k; this.config[k] = inp.type==='number'? Number(inp.value) : inp.value; this.save(); this._cfgHandlers.forEach(h=>h()); });
  }); }
  Widget.prototype.onCfg = function(fn){ (this._cfgHandlers||(this._cfgHandlers=[])).push(fn); }
  Widget.prototype.ensureConfig = function(defaults){ this.config = Object.assign({}, defaults, this.load()||{}); return this.config; }
  Widget.prototype.save = function(){ const id = this.el.parentElement.getAttribute('gs-id'); state.configs[id] = this.config; persist(); }
  Widget.prototype.load = function(){ const id = this.el.parentElement.getAttribute('gs-id'); return state.configs[id]; }
  Widget.prototype.interval = function(fn, ms){ fn(); const t = setInterval(fn, ms); this._timers=(this._timers||[]); this._timers.push(t); }
  Widget.prototype.destroy = function(){ (this._timers||[]).forEach(clearInterval); }

  // --- State persistence ---
  let state = JSON.parse(localStorage.getItem('dash:state')||'{}');
  if(!state.nodes){ state = { nodes:[], configs:{} }; }

  function persist(){ localStorage.setItem('dash:state', JSON.stringify(state)); savePrefs(); }

  function saveLayout(){
    const nodes = grid.engine.nodes.map(n=>({x:n.x,y:n.y,w:n.w,h:n.h,id:n.id, type:n.el.querySelector('.widget').dataset.type}));
    state.nodes = nodes; persist(); alert('Layout gespeichert.');
  }
  function resetLayout(){ if(confirm('Layout & Konfiguration wirklich zur√ºcksetzen?')){ localStorage.removeItem('dash:state'); location.reload(); } }
  document.getElementById('saveLayout').addEventListener('click', saveLayout);
  document.getElementById('resetLayout').addEventListener('click', resetLayout);

  // --- Add widgets ---
  function addWidget(type){
    const tpl = document.getElementById('tpl-widget');
    const frag = tpl.content.cloneNode(true);
    const item = frag.querySelector('.grid-stack-item');
    item.setAttribute('gs-id', __uuid());
    const content = item.querySelector('.grid-stack-item-content');
    content.dataset.type = type;
    const spec = types[type];
    if(spec?.size){ item.setAttribute('gs-w', spec.size[0]); item.setAttribute('gs-h', spec.size[1]); }
    grid.addWidget(item);
    mount(content);
    updateEmpty();
  }

  function addPicker(){
    const tpl = document.getElementById('tpl-widget-picker');
    const frag = tpl.content.cloneNode(true);
    const item = frag.querySelector('.grid-stack-item');
    item.setAttribute('gs-id', __uuid());
    grid.addWidget(item);
    const root = item.querySelector('.widget');
    root.querySelectorAll('[data-add]').forEach(btn=>btn.addEventListener('click', ()=>{ grid.removeWidget(item); addWidget(btn.dataset.add); }));
    root.querySelector('.icon-del').addEventListener('click', ()=> grid.removeWidget(item));
  }

  document.getElementById('addWidget').addEventListener('click', addPicker);

  // --- Mount a widget element ---
  function mount(content){
    const w = new Widget(content);
    const spec = types[content.dataset.type];
    if(!spec){ content.querySelector('.w-body').innerHTML = '<p>Unbekannter Typ</p>'; return; }

    // header actions
    content.querySelector('.icon-edit').addEventListener('click', ()=>{
      const isOpen = content.classList.toggle('cfg-open');
      content.querySelector('.cfg').style.display = isOpen? 'grid':'none';
    });
    content.querySelector('.icon-del').addEventListener('click', ()=>{
      if(confirm('Widget entfernen?')){
        const node = content.closest('.grid-stack-item');
        grid.removeWidget(node); delete state.configs[node.getAttribute('gs-id')]; persist(); updateEmpty();
        w.destroy();
      }
    });

    spec.render(w);
  }

  // --- Restore state or add defaults ---
  function restore(){
    if(state.nodes.length){
      grid.removeAll();
      state.nodes.forEach(n=>{
        const node = document.createElement('div');
        node.className='grid-stack-item'; node.setAttribute('gs-x',n.x); node.setAttribute('gs-y',n.y); node.setAttribute('gs-w',n.w); node.setAttribute('gs-h',n.h); node.setAttribute('gs-id', n.id||__uuid());
        const content = document.createElement('div'); content.className='grid-stack-item-content widget'; content.dataset.type = n.type;
        content.innerHTML = `<div class="w-header"><div class="w-title"></div><div class="w-actions"><button class="iconBtn icon-edit">‚öôÔ∏è</button><button class="iconBtn icon-del">üóëÔ∏è</button></div></div><div class="w-body"></div><div class="cfg"></div>`;
        node.appendChild(content); grid.addWidget(node); mount(content);
      });
    }else{
      // Defaults for first run
      addWidget('clock');
      addWidget('weather');
      addWidget('gcal');
      addWidget('crypto');
      addWidget('stocks');
      addWidget('custom');
    }
    updateEmpty();
  }
  restore();

  // Apply prefs on start
  live = !!prefs.live; applyMode(); applyZoom();

  }
})();
</script>
</body>
</html>
